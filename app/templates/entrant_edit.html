{% extends "editor.html" %}

{% block header %}
{{ super() }}
<style>
#document_header {
    font-size: 150%;
}

#descriptors {
    margin-top: 5px;
}

.del-btn {
    background-color: Transparent;
    border: none;
    margin-left: 0.3em;
    cursor: pointer;
}

.attr-list {
    margin-top: 2em;
    margin-bottom: 0;
}

.attr-item {
    background-color: #DCDCDC;
    padding: 0.2em;
    border-radius: 5px;
    margin-top: 0.2em;
}

.attr-label {
    padding: 0.5em;
}

label {
    margin-bottom: 0;
    margin-top: 0.5rem;
}

label.radio-inline {
    margin-top: 0;
    margin-right:0.5rem;
}


</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class='col-md-11'>
            <h2 id="doc_header"><h2>{{ rec.document.citation }}</h2>
            <h3>Individual Details</h3>
        </div>
        <div class='col-md-1'>
            <a href="{{ url_for('edit_record', recId=rec.id)}}">Back</a>
        </div>
    </div>
    <div id="entrant_form">
        <form action="" method="">
            <h4>Name</h4>
            <table class="table">
                <thead>
                    <tr>
                      <th scope="col">First</th>
                      <th scope="col">Last</th>
                      <th scope="col">Type</th>
                      <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id="names">
                    <tr data-name-id="1" class="name-row">
                        <td>
                            <input type="text" class="form-control" />
                        </td>
                        <td><input type="text" class="form-control" /></td>
                        <td>
                            <select class="form-control steve-dropdown">
                            {% for opt in nametypes %}
                                <option value="{{opt.id}}">{{opt.value}}</option>
                            {% endfor %}
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-danger name-btn">
                                <span class="fas fa-times-circle"></span>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="row">
                <div class='col-md-6'>
                    <button class="btn btn-primary" id="add-name">Add Name</button>
                </div>
            </div>
            <div id="names">
            </div>
            <hr/>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-3">
                        <label for="entrant_age">Age</label>
                        <input class="form-control" type="text" id="entrant_age" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <label>Gender</label>
                        <div class="row">
                            <div class="col-md-6" id="gender_select">
                                <label class="radio-inline">
                                  <input type="radio" name="entrant_gender" id="gender_male" value="Male">
                                  Male
                                </label>
                                <label class="radio-inline">
                                  <input type="radio" name="entrant_gender" id="gender_female" value="Female">
                                  Female
                                </label>
                                <label class="radio-inline">
                                  <input type="radio" name="entrant_gender" id="gender_other" value="Other" checked>
                                  Other/Unknown
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr/>
            <div class='form-group'>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Race</label>
                        <select class="form-control steve-tags" multiple="multiple">
                        {% for opt in races %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Tribe</label>
                        <select class="form-control steve-tags" multiple="multiple">
                        {% for opt in tribes %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Origin</label>
                        <select class="form-control steve-tags" multiple="multiple">
                        {% for opt in origins %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Status</label>
                        <select class="form-control steve-tags" multiple="multiple">
                        {% for opt in enslavements %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Title</label>
                        <select class="form-control steve-tags" multiple="multiple">
                        {% for opt in titles %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Vocation</label>
                        <select class="form-control steve-tags" multiple="multiple">
                        {% for opt in vocations %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class='col-md-6'>
                <button type="submit" class="btn btn-primary" id="rec_update">Update</button>
            </div>
        </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts%}
{{ super() }}
<script>

var updateRadio = function($radioSelect, val) {
    var $radio_opt;
    $radio_opt = $radioSelect.find(`input:radio[value=${val}]`);
    if ( $radio_opt ) {
        $radio_opt.prop('checked', true);
    } else {
        return;
    }
}



var updateEntrantAttribute = function($attList, attData, attGroup) {
    $new_attribute = makeAttribute($attList, attData, attGroup);
    $attList.append($new_attribute);
    return $attList;
}

var makeAttribute = function ($attList, data, attGroup) {
    var $li, $span, $button,
        $icon;
    const data_id_field = `data-${attGroup}-id`;
    $li = $('<li/>', { 
        'class': `entrant_${attGroup} list-inline-item attr-item`,
        });
    $li.attr(data_id_field, data.id);
    $span = $('<span/>', { 'text' : data.value,
                        'class': `${attGroup}-name attr-label` });
    $button = $('<button/>', { 'class': `del-btn` });
    $icon = $('<span/>', { 'class': 'fas fa-times-circle' });

    $button.append($icon);
    $button.on('click', function(e) {
        e.preventDefault();
        removeAttribute($attList,
            $li.attr(data_id_field), data_id_field);
    })

    $li.append($span).append($button);
    return $li;
}

var removeAttribute = function ($attList, dataId, dataIdField) {
    var $att;

    $att = $attList.find(`li[${dataIdField}='${dataId}']`).last();
    $att.remove();
}

var updateAttributeList = function ($container, attArray, attGroup) {
    var $tag_list = $container.find($('ul.select2-selection__rendered'));
    $tag_list.empty();
    for ( var i=0; i < attArray.length; i++ ) {
        var att_data = attArray[i];
        $attList = updateEntrantAttribute(
            $attList, att_data, attGroup);
    }
}

var initializeForm = function(entData) {
    if ( $.isEmptyObject(entData) ) {
        return;
    }
    $('#entrant_age').val(entData['age']);
    updateRadio($('#gender_select'), entData['sex']);
    updateAttributeList($('#races'), entData['races'], 'races');
    updateAttributeList($('#tribes'), entData['tribes'], 'tribes');
    updateAttributeList($('#origins'), entData['origins'], 'origins');
    updateAttributeList($('#titles'), entData['titles'], 'titles');
    updateAttributeList(
        $('#statuses'), entData['enslavements'], 'enslavements');
    updateAttributeList(
        $('#vocations'), entData['vocations'], 'vocations');
}

var readEntrantData = function(entId) {
    var ent_data_api = "{{ url_for('read_entrant_data', entId=None ) }}" + entId;
    var out = null;
    $.get(ent_data_api, function(data) {
        initializeForm(data['ent']);
    });
}

var addNameInput = function($nameContainer, nameData, nameTypes) {
    var $tr, $td1, $td2, $td3, $td4,
        $input1, $input2, $select,
        $button, $span;

    $tr = $('<tr/>', { 'class': 'name-row'});
    $td1 = $('<td/>');
    $td2 = $('<td/>');
    $td3 = $('<td/>');
    $td4 = $('<td/>');
    $input1 = $('<input/>',
        { 'class': 'form-control name-first', 'type': 'text' });
    $input2 = $('<input/>',
        { 'class': 'form-control name-last', 'type': 'text' });
    $select = $('<select/>',
        { 'class': 'form-control'});

    for (var i = 0; i < nameTypes.length; i++) {
        var opt = nameTypes[i];
        var $opt = $("<option/>", { 'value': opt.id ,
                                        'text': opt.value });
        if (opt.value === nameData['name_type']) {
            $opt.prop('selected', true);
        }
        $select.append($opt);
    }

    $button = $('<button/>', { 'class': 'btn btn-danger del-name'});
    $span = $('<span/>', {'class': 'fas fa-times-circle'});

    $button.append($span);
    $td1.append($input1);
    $td2.append($input2);
    $td3.append($select);
    $td4.append($button);
    $tr.append($td1).append($td2).append($td3).append($td4);
    $nameContainer.append($tr);

    return $nameContainer;
}

var getEntId = function () {
    var ent_id = "{{ ent.id or '' }}";
    return ent_id;
}

$( document ).ready(function() {
    var ent_id = getEntId();
    var name_types = JSON.parse('{{ nametypes | tojson | safe}}');

    readEntrantData(ent_id);
    $('#add-name').on('click', function(e) {
        e.preventDefault();

        var blank_name = { 'first': '', 'last': '',
            'name_type': 'Given', 'id': '-1' };
        addNameInput($('#names'), blank_name, name_types);
    });
    $('#names').on('click', '.del-name', function(e) {
        e.preventDefault();
        var $name_row = $( this ).closest('.name-row');
        
        console.log($name_row);
        $name_row.remove();
    });
});
</script>
{% endblock %}