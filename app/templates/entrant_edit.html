{% extends "editor.html" %}

{% block header %}
{{ super() }}
<style>
#document_header {
    font-size: 150%;
}

#descriptors {
    margin-top: 5px;
}

.del-btn {
    background-color: Transparent;
    border: none;
    margin-left: 0.3em;
    cursor: pointer;
}

.attr-list {
    margin-top: 2em;
    margin-bottom: 0;
}

.attr-item {
    background-color: #DCDCDC;
    padding: 0.2em;
    border-radius: 5px;
    margin-top: 0.2em;
}

.attr-label {
    padding: 0.5em;
}

label {
    margin-bottom: 0;
    margin-top: 0.5rem;
}

label.radio-inline {
    margin-top: 0;
    margin-right:0.5rem;
}


</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class='col-md-11'>
            <h2 id="doc_header"><h2>{{ rec.document.citation }}</h2>
            <h3>Individual Details</h3>
        </div>
        <div class='col-md-1'>
            <a href="{{ url_for('edit_record', recId=rec.id)}}">Back</a>
        </div>
    </div>
    <div id="entrant_form">
        <form action="" method="">
            <h4>Name</h4>
            <table class="table">
                <thead>
                    <tr>
                      <th scope="col">First</th>
                      <th scope="col">Last</th>
                      <th scope="col">Type</th>
                      <th scope="col"></th>
                    </tr>
                </thead>
                <tbody id="names">
                </tbody>
            </table>
            <div class="row">
                <div class='col-md-6'>
                    <button class="btn btn-primary" id="add-name">Add Name</button>
                </div>
            </div>
            <hr/>
            <div class="form-group">
                <div class="row">
                    <div class="col-md-3">
                        <label for="entrant_age">Age</label>
                        <input class="form-control" type="text" id="entrant_age" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <label>Gender</label>
                        <div class="row">
                            <div class="col-md-6" id="gender_select">
                                <label class="radio-inline">
                                  <input type="radio" name="entrant_gender" id="gender_male" value="Male">
                                  Male
                                </label>
                                <label class="radio-inline">
                                  <input type="radio" name="entrant_gender" id="gender_female" value="Female">
                                  Female
                                </label>
                                <label class="radio-inline">
                                  <input type="radio" name="entrant_gender" id="gender_other" value="Other" checked>
                                  Other/Unknown
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr/>
            <div class='form-group'>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Race</label>
                        <select  id="races" class="form-control steve-tags" multiple="multiple">
                        {% for opt in races %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Tribe</label>
                        <select id="tribes" class="form-control steve-tags" multiple="multiple">
                        {% for opt in tribes %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Origin</label>
                        <select id="origins" class="form-control steve-tags" multiple="multiple">
                        {% for opt in origins %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Status</label>
                        <select id="enslavements" class="form-control steve-tags" multiple="multiple">
                        {% for opt in enslavements %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Title</label>
                        <select id="titles" class="form-control steve-tags" multiple="multiple">
                        {% for opt in titles %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6'>
                        <label>Vocation</label>
                        <select id="vocations" class="form-control steve-tags" multiple="multiple">
                        {% for opt in vocations %}
                            <option value="{{opt.id}}">{{opt.value}}</option>
                        {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class='col-md-6'>
                    <button type="submit" class="btn btn-primary" id="details_update">Update</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts%}
{{ super() }}
<script>

var updateRadio = function($radioSelect, val) {
    var $radio_opt;
    $radio_opt = $radioSelect.find(`input:radio[value=${val}]`);
    if ( $radio_opt ) {
        $radio_opt.prop('checked', true);
    } else {
        return;
    }
}

var updateAttributeList = function ($container, attArray, attGroup) {
    var attribute_ids = [];
    for (var x=0; x < attArray.length; x++) {
        attribute_ids.push(attArray[x].id);
    }
    $container.val(attribute_ids);
    $container.trigger('change');
}

var initializeForm = function(entData, nameTypes) {
    if ( $.isEmptyObject(entData) ) {
        var blank_name = { 'first': '', 'last': '',
            'name_type': 'Given', 'id': 'name' };
        addNameInput($('#names'), blank_name, nameTypes);
        disableNameDeletion($('#names'));
        return;
    }
    for (var i=0; i < entData['names'].length; i++ ) {
        addNameInput(
            $('#names'), entData['names'][i], nameTypes );
    }
    disableNameDeletion($('#names'));
    $('#entrant_age').val(entData['age']);
    updateRadio($('#gender_select'), entData['sex']);
    updateAttributeList($('#races'), entData['races'], 'races');
    updateAttributeList($('#tribes'), entData['tribes'], 'tribes');
    updateAttributeList($('#origins'), entData['origins'], 'origins');
    updateAttributeList($('#titles'), entData['titles'], 'titles');
    updateAttributeList(
        $('#statuses'), entData['enslavements'], 'enslavements');
    updateAttributeList(
        $('#vocations'), entData['vocations'], 'vocations');
}

var addNameInput = function($nameContainer, nameData, nameTypes) {
    var $tr, $td1, $td2, $td3, $td4,
        $input1, $input2, $select,
        $button, $span;

    $tr = $('<tr/>', { 'class': 'name-row',
        'data-name-id': nameData['id']});
    $td1 = $('<td/>');
    $td2 = $('<td/>');
    $td3 = $('<td/>');
    $td4 = $('<td/>');
    $input1 = $('<input/>', {
        'class': 'form-control name-first',
        'type': 'text',
        'value': nameData['first'] });
    $input2 = $('<input/>', {
        'class': 'form-control name-last',
        'type': 'text',
        'value': nameData['last'] });
    $select = $('<select/>',
        { 'class': 'form-control name-type'});

    for (var i = 0; i < nameTypes.length; i++) {
        var opt = nameTypes[i];
        var $opt = $("<option/>", { 'value': opt.id ,
                                    'text': opt.value });
        if (opt.value === nameData['name_type']) {
            $opt.prop('selected', true);
        }
        $select.append($opt);
    }

    $button = $('<button/>', { 'class': 'btn btn-danger del-name'});
    $span = $('<span/>', {'class': 'fas fa-times-circle'});

    $button.append($span);
    $td1.append($input1);
    $td2.append($input2);
    $td3.append($select);
    $td4.append($button);
    $tr.append($td1).append($td2).append($td3).append($td4);
    $nameContainer.append($tr);

    disableNameDeletion($nameContainer);
    return $nameContainer;
}

var disableNameDeletion = function($container) {
    var $rows = $container.find('.name-row');
    if ($rows.length == 1) {
        $rows.find('button').prop('disabled', true);
    } else {
        $rows.find('button').prop('disabled', false);
    }
    return;
}

var getNameData = function($container) {
    var name_data = [];
    $rows = $container.find('.name-row');
    $rows.each( function(idx) {
        var $row = $( this );
        var data = {};
        data['id'] = $row.attr('data-name-id');
        data['first'] = $row.find('.name-first').val();
        data['last'] = $row.find('.name-last').val();
        data['name_type'] = $row.find('.name-type').val();
        name_data.push(data);
    });

    return name_data;
}

var getAgeData = function ( $container ) {
    return $container.val();
}

var getGenderData = function ( $container ) {
    return $container.find(':checked').val();
}

var getAttributeData = function( $container ) {
    var att_data = [];
    $opts = $container.find(':selected');
    $opts.each( function(idx) {
        var $opt = $( this );
        var data = {};
        data['id'] = $opt.val();
        data['name'] = $opt.text();
        att_data.push(data);
    });

    return att_data;
}

var getEntId = function () {
    var ent_id = "{{ ent.id or '' }}";
    return ent_id;
}

var getFormData = function( $container ) {
    var data = {};
    data['names'] = getNameData($('#names'));
    data['age'] = getAgeData($('#entrant_age'));
    data['sex'] = getGenderData($('#gender_select'));
    data['races'] = getAttributeData($('#races'));
    data['tribes'] = getAttributeData($('#tribes'));
    data['origins'] = getAttributeData($('#origines'));
    data['statuses'] = getAttributeData($('#statuses'));
    data['titles'] = getAttributeData($('#titles'));
    data['vocations'] = getAttributeData($('#vocations'));
    return data;
}

var readEntrantData = function(entId, nameTypes) {
    var ent_data_api = "{{ url_for('read_entrant_data', entId=None ) }}" + entId;
    var out = null;
    $.get(ent_data_api, function(data) {
        initializeForm(data['ent'], nameTypes);
    });
}

var updateEntrantDetails = function(entId, dataObj) {
    var ent_data_api = "{{ url_for('update_entrant', entId=None )}}" + entId;
    $.ajax({
        type: "PUT",
        url: ent_data_api,
        contentType: "application/json",
        data: JSON.stringify(dataObj),
        success: function(data) {
            window.location.href = data.redirect;
        }
    });
}

$( document ).ready(function() {
    var ent_id = getEntId();
    var name_types = JSON.parse('{{ nametypes | tojson | safe}}');

    readEntrantData(ent_id, name_types);
    $('#add-name').on('click', function(e) {
        e.preventDefault();

        var blank_name = { 'first': '', 'last': '',
            'name_type': 'Given', 'id': 'name' };
        addNameInput($('#names'), blank_name, name_types);
    });
    $('#names').on('click', '.del-name', function(e) {
        e.preventDefault();
        var $name_row = $( this ).closest('.name-row');
        
        $name_row.remove();
        disableNameDeletion($('#names'));
    });
    $('#entrant_form').on('click', '#details_update', function(e) {
        e.preventDefault();
        var data = getFormData($('#entrant_form'));
        updateEntrantDetails(ent_id, data);
    });
});
</script>
{% endblock %}