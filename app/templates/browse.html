{% extends "base.html" %}

{% block header %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="shortcut icon" type="image/ico" href="favicon.ico" />
    <link rel="stylesheet" 
          href="{{ url_for('static', filename='lib/slickgrid/css/smoothness/jquery-ui-1.11.3.custom.css') }}" 
          type="text/css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/slickgrid/slick.grid.css') }}" type="text/css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/browse.css') }}" type="text/css"/>
{% endblock %}

{% block content %}
	<header>
		<h1>Browse the Database</h1>
	</header>
	
	<div id="grid-container">
		<div id="myGrid" style="width:100%; height:100%;"></div>
	</div>
	<div class="info-box">
		<p>Note: Date is in year-month-day format.</p>
		<hr>
		<p>You can filter by multiple categories! For instance, to find
		female Wampanoags, type "female" below the gender header
		and "Wampanoag" below the Tribe / Nation header.
		<p>Click the <img src="{{ url_for('static', filename='img/info.png') }}"> icon for more information
		about the person.</p>
	</div>	
	<footer>
		
	</footer>

{% endblock %}

{% block scripts%}
<script src="{{ url_for('static', filename='lib/slickgrid/lib/firebugx.js') }}"></script>
<script src="{{ url_for('static', filename='lib/slickgrid/lib/jquery-1.11.2.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/slickgrid/lib/jquery-ui-1.11.3.min.js') }}"></script>
<script src="{{ url_for('static', filename='lib/slickgrid/lib/jquery.event.drag-2.3.0.js') }}"></script>
<script src="{{ url_for('static', filename='lib/slickgrid/slick.core.js') }}"></script>
<script src="{{ url_for('static', filename='lib/slickgrid/slick.dataview.js') }}"></script>
<script src="{{ url_for('static', filename='lib/slickgrid/slick.grid.js') }}"></script>
<script src="{{ url_for('static', filename='js/granulated-sugar.js') }}"></script>
<script src="{{ url_for('static', filename='js/browse.js') }}"></script>

<script>
$.get("{{ url_for('static', filename='data/denormalized.json')}}", (some_data, status) => {
	raw_data = some_data;
	data = [];
	for (let i = 0; i < raw_data.length; i++) {
		var rec = raw_data[i];
		data.push({
			pic: "",
			persNumber: String(i),
			id: rec.id,
			date: formatDate(rec.date),
			name: rec.first_name + " " + rec.last_name,
			race: rec.description.race,
			origin: rec.description.origin,
			tribe: formatTribe(rec.description.tribe),
			sex: rec.description.sex,
			vocation: rec.description.vocation,
			status: rec.status,
			// abbrNotes: ((raw_data[i].additionalInformation + " " + raw_data[i].researcherNotes))
		});
	}
	dataView = new Slick.Data.DataView();
	grid = new Slick.Grid("#myGrid", dataView, columns, options);
	dataView.onRowCountChanged.subscribe(function (e, args) {
		grid.updateRowCount();
		grid.render();
	});
	dataView.onRowsChanged.subscribe(function (e, args) {
		grid.invalidateRows(args.rows);
		grid.render();
	});
	$(grid.getHeaderRow()).on("change keyup", ":input", function (e) {
		var columnId = $(this).data("columnId");
		if (columnId != null) {
			columnFilters[columnId] = $.trim($(this).val());
			dataView.refresh();
		}
	});
	grid.onHeaderRowCellRendered.subscribe(function(e, args) {
		$(args.node).empty();
		$("<input type='text'>")
			.data("columnId", args.column.id)
			.val(columnFilters[args.column.id])
			.appendTo(args.node);
	});
	grid.onSort.subscribe(function(e, args) {
		console.log(args);
		var comparer = function(a, b) {
			return (a[args.sortCol.field] > 
			        b[args.sortCol.field]) ? 1 : -1;
		}
		dataView.beginUpdate();
		dataView.sort(comparer, args.sortAsc);
		dataView.endUpdate();
	});
	grid.init();
	dataView.beginUpdate();
	dataView.setItems(data);
	dataView.setFilter(filter);
	dataView.endUpdate();
});
</script>
{% endblock %}
